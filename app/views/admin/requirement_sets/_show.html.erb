<%return unless @requirement_set%>

<style type="text/css">
    .boxy-content {
        margin:5px;padding:0;
    }
</style>

<div id="rs_name"
     class="heading editable"
     data-update_value="'requirement_set[name]'"><%=@requirement_set.name%></div>
required by

<span id="required_roles" data-required_role_ids="[<%=required_role_ids.map{|id|"'#{id}'"}.join(",")%>]" class="editable">
  <%=required_roles_list%>
</span>, assigned to

<span id="required_org_units" data-required_ou_ids="[<%=required_ou_ids.map{|id|"'#{id}'"}.join(",")%>]" class="editable">
  <%=required_ou_list%>
</span>

<hr>
<%@requirement_set.requirement_groups.each do |group|%>
    <div class="requirement_group">
      <span
      class="editable"
      data-select_options="'<%=credential_group_operators_options%>'"
      data-field_type='"select"'
      data-update_value="'requirement_group[rule_operator]'"
      data-url='"requirement_sets/<%=@requirement_set.id%>/requirement_groups/<%=group.id%>"'>
        <%=group.rule_operator.to_s.titleize%>
    </span>
       of the following items are required to satisfy this requirement:
    </div>
<%end%>


<script language="javascript">
    var updateUrl = "departments/<%=@department.id%>/requirement_sets/<%=@requirement_set.id%>";
    $("#required_roles").click(function(){
        var selected_ids = eval($(this).attr("data-required_role_ids"));
        $.maestro.dialogs.roleSelector('<%=@department.id%>',selected_ids,{
            title:"Select the roles this requirement applies to",
            onSelection:function(selected){
                var ids = selected && selected[1] && selected[1].length > 0 ? selected[1] : "";
                $.ajax({
                    type: 'POST',
                    url: updateUrl,
                    data: {_method:'put',requirement_set:{organizational_role_ids:ids}},
                    dataType: 'json',
                    success: function(data){
                        $("#required_roles").text((selected.length > 0 && selected[0] != "") ? selected[0].join(", ") : "all departmental employees")
                                .attr("data-required_role_ids","[" + $.map(selected[1],function(id){return "'" + id + "'"}).join(",") + "]");
                    }
                });
            }
        });
    });

    $("#required_org_units").click(function(){
        var selected_ids = eval($(this).attr("data-required_ou_ids"));
        $.maestro.dialogs.organizationalUnitSelector(selected_ids,{
            title:"Select the locations this requirement applies to",
            onSelection:function(selected){
                var ids = selected && selected[1] && selected[1].length > 0 ? selected[1] : "";
                $.ajax({
                    type:'POST',
                    url:updateUrl,
                    data:{_method:'put',requirement_set:{organizational_unit_ids:ids}},
                    dataType:'json',
                    success:function(data){
                        $("#required_org_units").text((selected.length > 0 && selected[0] != "") ? selected[0].join(", ") : "any location")
                                .attr("data-required_ou_ids","[" + $.map(selected[1],function(id){return "'" + id + "'"}).join(",") + "]");
                    }
                })
            }
        })
    });

    $.fn.editInPlace.defaults.url=updateUrl;
    $('.editable').editInPlace();
</script>
